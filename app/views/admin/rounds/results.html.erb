<% content_for :title, "Resultados - Rodada #{@round.number}" %>
<%= breadcrumb ["Inicio", root_path], ["Admin", admin_championships_path], ["Campeonatos", admin_championships_path], [@championship.full_name, admin_championship_path(@championship)], "Rodada #{@round.number}" %>

<div style="text-align: center; margin-bottom: 30px;">
  <h1 style="color: #000080;">Resultados - Rodada <%= @round.number %></h1>
  <p style="font-size: 18px; color: #666; margin-top: 10px;">
    <strong><%= @championship.full_name %></strong>
  </p>
  <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
    <%= link_to "Voltar", admin_championship_path(@championship), class: "btn" %>
    <%= button_to "Calcular Rankings", calculate_rankings_admin_round_path(@round), method: :post, class: "btn", style: "background: #007bff;" %>
  </div>
</div>

<div class="card">
  <h2 style="text-align: center; margin-bottom: 20px;">Informar Resultados</h2>
  
  <%= form_with url: finalize_all_admin_round_path(@round), method: :post, local: true do %>
    <table>
      <thead>
        <tr>
          <th style="text-align: center;">Data/Hora</th>
          <th style="text-align: right;">Mandante</th>
          <th style="text-align: center;">Placar</th>
          <th>Visitante</th>
          <th style="text-align: center; width: 60px;">
            <input type="checkbox" id="select-all-finished" title="Selecionar todos finalizados">
          </th>
          <th style="text-align: center;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% @matches.each do |match| %>
          <% bg_color = match.finished? ? 'background: #e8f5e9;' : '' %>
          <tr style="<%= bg_color %>">
            <td style="text-align: center;"><%= match.scheduled_at&.strftime("%d/%m %H:%M") %></td>
            <td style="text-align: right;">
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                <strong><%= match.home_club.name %></strong>
                <% if match.home_club.badge_url %>
                  <%= image_tag match.home_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.home_club.primary_color %>; border-radius: 3px;"></div>
                <% end %>
              </div>
            </td>
            <td style="text-align: center;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                <%= number_field_tag "matches[#{match.id}][home_score]", match.home_score, min: 0, max: 20, disabled: match.finished?, style: "width: 50px; text-align: center; padding: 5px;", id: "match_#{match.id}_home" %>
                <strong>x</strong>
                <%= number_field_tag "matches[#{match.id}][away_score]", match.away_score, min: 0, max: 20, disabled: match.finished?, style: "width: 50px; text-align: center; padding: 5px;", id: "match_#{match.id}_away" %>
              </div>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <% if match.away_club.badge_url %>
                  <%= image_tag match.away_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.away_club.primary_color %>; border-radius: 3px;"></div>
                <% end %>
                <strong><%= match.away_club.name %></strong>
              </div>
            </td>
            <!-- Coluna Checkbox -->
            <td style="text-align: center;">
              <% if match.finished? %>
                <input type="checkbox" name="match_ids[]" value="<%= match.id %>" class="finished-checkbox">
              <% end %>
            </td>
            <td style="text-align: center;">
              <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <!-- Botão Finalizar Individual -->
                <% if !match.finished? %>
                  <button type="button"
                          onclick="finalizeMatch(<%= match.id %>)"
                          style="background: none; border: none; padding: 0; cursor: pointer;" 
                          title="Finalizar partida">
                    <%= image_tag 'finish-icon.svg', style: 'width: 32px; height: 32px;' %>
                  </button>
                <% else %>
                  <span style="opacity: 0.5;">
                    <%= image_tag 'finish-icon.svg', style: 'width: 32px; height: 32px; filter: grayscale(100%);' %>
                  </span>
                <% end %>
                
                <!-- Botão Reabrir -->
                <% if match.finished? %>
                  <button type="button"
                          onclick="reopenMatch(<%= match.id %>)"
                          style="background: none; border: none; padding: 0; cursor: pointer;" 
                          title="Reabrir para edição">
                    <%= image_tag 'reload-icon.svg', style: 'width: 32px; height: 32px;' %>
                  </button>
                <% else %>
                  <span style="opacity: 0.5;">
                    <%= image_tag 'reload-icon.svg', style: 'width: 32px; height: 32px; filter: grayscale(100%);' %>
                  </span>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <!-- Botão Finalizar Jogos -->
      <% if @matches.any? { |m| !m.finished? } %>
        <%= submit_tag "Finalizar Jogos", 
            class: "btn", 
            style: "background: #28a745; padding: 12px 40px; font-size: 16px;", 
            data: { confirm: 'Finalizar os jogos com placares preenchidos?' } %>
      <% end %>
    
      <!-- Botão Reabrir Jogos -->
      <% if @matches.any?(&:finished?) %>
        <%= button_tag "Reabrir Jogos", 
            type: "button",
            class: "btn", 
            style: "background: #ff9800; padding: 12px 40px; font-size: 16px;",
            onclick: "submitReopenForm()" %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
// Selecionar/desselecionar todos os jogos finalizados
document.getElementById('select-all-finished')?.addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.finished-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// Função para reabrir jogos selecionados
function submitReopenForm() {
  const checkedBoxes = document.querySelectorAll('.finished-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert('Selecione pelo menos um jogo finalizado para reabrir!');
    return false;
  }
  
  if (!confirm('Reabrir os ' + checkedBoxes.length + ' jogo(s) selecionado(s)?')) {
    return false;
  }
  
  // Criar formulário do zero (igual às funções individuais)
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '<%= reopen_all_admin_round_path(@round) %>';
  
  // Adicionar token CSRF
  const token = document.querySelector('meta[name="csrf-token"]').content;
  const tokenInput = document.createElement('input');
  tokenInput.type = 'hidden';
  tokenInput.name = 'authenticity_token';
  tokenInput.value = token;
  form.appendChild(tokenInput);
  
  // Adicionar os IDs dos jogos selecionados
  checkedBoxes.forEach(function(checkbox) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'match_ids[]';
    input.value = checkbox.value;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
}
// Finalizar jogo individual
  function finalizeMatch(matchId) {
    const homeField = document.getElementById('match_' + matchId + '_home');
    const awayField = document.getElementById('match_' + matchId + '_away');
    
    if (!homeField.value || !awayField.value) {
      alert('Preencha os placares antes de finalizar!');
      return;
    }
    
    if (!confirm('Finalizar esta partida?')) {
      return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/matches/' + matchId + '/finalize';
    
    const token = document.querySelector('meta[name="csrf-token"]').content;
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'authenticity_token';
    tokenInput.value = token;
    form.appendChild(tokenInput);
    
    const homeInput = document.createElement('input');
    homeInput.type = 'hidden';
    homeInput.name = 'match[home_score]';
    homeInput.value = homeField.value;
    form.appendChild(homeInput);
    
    const awayInput = document.createElement('input');
    awayInput.type = 'hidden';
    awayInput.name = 'match[away_score]';
    awayInput.value = awayField.value;
    form.appendChild(awayInput);
    
    document.body.appendChild(form);
    form.submit();
  }
  
  // Reabrir jogo individual
  function reopenMatch(matchId) {
    if (!confirm('Reabrir esta partida para edição?')) {
      return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/matches/' + matchId + '/reopen';
    
    const token = document.querySelector('meta[name="csrf-token"]').content;
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'authenticity_token';
    tokenInput.value = token;
    form.appendChild(tokenInput);
    
    document.body.appendChild(form);
    form.submit();
  }
</script>