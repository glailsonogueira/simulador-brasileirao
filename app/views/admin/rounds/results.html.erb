<% content_for :title, "Resultados - Rodada #{@round.number}" %>
<%= breadcrumb ["Inicio", root_path], ["Admin", admin_championships_path], ["Campeonatos", admin_championships_path], [@championship.full_name, admin_championship_path(@championship)], "Rodada #{@round.number}" %>

<div style="text-align: center; margin-bottom: 30px;">
  <h1 style="color: #000080;">Resultados - Rodada <%= @round.number %></h1>
  <p style="font-size: 18px; color: #666; margin-top: 10px;">
    <strong><%= @championship.full_name %></strong>
  </p>
  <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
    <%= link_to "Voltar", admin_championship_path(@championship), class: "btn" %>
    <%= button_to "Calcular Rankings", calculate_rankings_admin_round_path(@round), method: :post, class: "btn", style: "background: #007bff;" %>
  </div>
</div>

<div class="card">
  <h2 style="text-align: center; margin-bottom: 20px;">Informar Resultados</h2>
  
  <%= form_with url: finalize_all_admin_round_path(@round), method: :post, local: true do %>
    <table>
      <thead>
        <tr>
          <th style="text-align: center;">Data/Hora</th>
          <th style="text-align: right;">Mandante</th>
          <th style="text-align: center;">Placar</th>
          <th>Visitante</th>
          <th style="text-align: center;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% @matches.each do |match| %>
          <% bg_color = match.finished? ? 'background: #e8f5e9;' : '' %>
          <tr style="<%= bg_color %>">
            <td style="text-align: center;"><%= match.scheduled_at&.strftime("%d/%m %H:%M") %></td>
            <td style="text-align: right;">
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                <strong><%= match.home_club.name %></strong>
                <% if match.home_club.badge_url %>
                  <%= image_tag match.home_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.home_club.primary_color %>; border-radius: 3px;"></div>
                <% end %>
              </div>
            </td>
            <td style="text-align: center;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                <%= number_field_tag "matches[#{match.id}][home_score]", match.home_score, min: 0, max: 20, disabled: match.finished?, style: "width: 50px; text-align: center; padding: 5px;", id: "match_#{match.id}_home" %>
                <strong>x</strong>
                <%= number_field_tag "matches[#{match.id}][away_score]", match.away_score, min: 0, max: 20, disabled: match.finished?, style: "width: 50px; text-align: center; padding: 5px;", id: "match_#{match.id}_away" %>
              </div>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <% if match.away_club.badge_url %>
                  <%= image_tag match.away_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.away_club.primary_color %>; border-radius: 3px;"></div>
                <% end %>
                <strong><%= match.away_club.name %></strong>
              </div>
            </td>
            <td style="text-align: center;">
              <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <!-- Botão Finalizar Individual -->
                <% if !match.finished? %>
                  <%= button_to finalize_admin_match_path(match), 
                      method: :post,
                      params: { 
                        match: { 
                          home_score: match.home_score, 
                          away_score: match.away_score 
                        } 
                      },
                      form: { 
                        onsubmit: "var homeField = document.getElementById('match_#{match.id}_home'); var awayField = document.getElementById('match_#{match.id}_away'); this.querySelector('input[name=\"match[home_score]\"]').value = homeField.value; this.querySelector('input[name=\"match[away_score]\"]').value = awayField.value; return confirm('Finalizar esta partida?');" 
                      },
                      style: "background: none; border: none; padding: 0; cursor: pointer;", 
                      title: "Finalizar partida" do %>
                    <%= image_tag 'finish-icon.svg', style: 'width: 32px; height: 32px;' %>
                  <% end %>
                <% else %>
                  <span style="opacity: 0.5;">
                    <%= image_tag 'finish-icon.svg', style: 'width: 32px; height: 32px; filter: grayscale(100%);' %>
                  </span>
                <% end %>
                
                <!-- Botão Reabrir -->
                <% if match.finished? %>
                  <%= button_to reopen_admin_match_path(match), 
                      method: :post,
                      form: { onsubmit: "return confirm('Reabrir esta partida para edição?');" },
                      style: "background: none; border: none; padding: 0; cursor: pointer;", 
                      title: "Reabrir para edição" do %>
                    <%= image_tag 'reload-icon.svg', style: 'width: 32px; height: 32px;' %>
                  <% end %>
                <% else %>
                  <span style="opacity: 0.5;">
                    <%= image_tag 'reload-icon.svg', style: 'width: 32px; height: 32px; filter: grayscale(100%);' %>
                  </span>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <!-- Botão Finalizar Todas as Abertas -->
      <% if @matches.any? { |m| !m.finished? } %>
        <%= submit_tag "Finalizar Todas Abertas", 
            class: "btn", 
            style: "background: #28a745; padding: 12px 40px; font-size: 16px;", 
            data: { confirm: 'Finalizar todas as partidas abertas?' } %>
      <% end %>
    <% end %>
    
    <!-- Botão Reabrir Todas as Fechadas -->
    <% if @matches.any?(&:finished?) %>
      <%= button_to "Reabrir Todas Fechadas", 
          reopen_all_admin_round_path(@round), 
          method: :post, 
          class: "btn", 
          style: "background: #ff9800; padding: 12px 40px; font-size: 16px;",
          data: { confirm: 'Reabrir todas as partidas finalizadas?' } %>
    <% end %>
  </div>
</div>