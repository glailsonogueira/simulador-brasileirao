<% content_for :title, "Rodada #{@round.number}" %>
<%= breadcrumb ['Inicio', root_path], ['Previsoes', predictions_path], "Rodada #{@round.number}" %>

<h1>Rodada <%= @round.number %></h1>

<div class="card">
  <%= form_with url: update_batch_predictions_path, method: :patch, local: true do %>
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th style="text-align: right;">Mandante</th>
          <th style="text-align: center;">Sua Previsao</th>
          <th>Visitante</th>
          <th style="text-align: center;">Status</th>
          <% if @round.all_matches_finished? %>
            <th style="text-align: center;">Placar Final</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @matches.each do |match| %>
          <% can_predict = match.can_predict? %>
          <% is_locked = match.locked? %>
          <tr style="<%= 'opacity: 0.6;' if is_locked %>">
            <td><%= match.scheduled_at&.strftime("%d/%m %H:%M") %></td>
            
            <td style="text-align: right;">
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                <strong><%= match.home_club.name %></strong>
                <% if match.home_club.special_club? %>
                  <span style="color: #ffc107; font-size: 16px;">&#9733;</span>
                <% end %>
                <% if match.home_club.badge_url %>
                  <%= image_tag match.home_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.home_club.primary_color || '#ccc' %>; border-radius: 3px;"></div>
                <% end %>
              </div>
            </td>
            
            <td style="text-align: center;">
              <% prediction = @predictions[match.id] %>
              <% if can_predict %>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                  <%= number_field_tag "predictions[#{match.id}][home]", prediction&.home_score, min: 0, max: 20, style: "width: 50px; text-align: center; padding: 5px;" %>
                  <strong>x</strong>
                  <%= number_field_tag "predictions[#{match.id}][away]", prediction&.away_score, min: 0, max: 20, style: "width: 50px; text-align: center; padding: 5px;" %>
                </div>
              <% else %>
                <% if prediction %>
                  <strong><%= prediction.home_score %> x <%= prediction.away_score %></strong>
                <% else %>
                  <span style="color: #999;">-</span>
                <% end %>
              <% end %>
            </td>
            
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <% if match.away_club.badge_url %>
                  <%= image_tag match.away_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.away_club.primary_color || '#ccc' %>; border-radius: 3px;"></div>
                <% end %>
                <% if match.away_club.special_club? %>
                  <span style="color: #ffc107; font-size: 16px;">&#9733;</span>
                <% end %>
                <strong><%= match.away_club.name %></strong>
              </div>
            </td>
            
            <td style="text-align: center;">
              <% if match.finished? %>
                <span style="color: #28a745; font-weight: bold;">Finalizado</span>
              <% elsif is_locked %>
                <span style="color: #dc3545; font-weight: bold;">Bloqueado</span>
              <% else %>
                <span style="color: #ffc107; font-weight: bold;">Aberto</span>
              <% end %>
            </td>
            
            <% if @round.all_matches_finished? %>
              <td style="text-align: center;">
                <% if match.finished? %>
                  <strong style="color: #28a745;"><%= match.home_score %> x <%= match.away_score %></strong>
                <% else %>
                  <span style="color: #999;">-</span>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @matches.any? { |m| m.can_predict? } %>
      <%= hidden_field_tag :round_id, @round.id %>
      <%= submit_tag "Salvar Previsoes", class: "btn", style: "margin-top: 20px;" %>
    <% else %>
      <p style="text-align: center; color: #999; margin-top: 20px;">Todos os jogos estao bloqueados ou finalizados.</p>
    <% end %>
  <% end %>
</div>
