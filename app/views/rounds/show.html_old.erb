<% content_for :title, "Rodada #{@round.number}" %>
<%= breadcrumb ['Inicio', root_path], ['Previsoes', predictions_path], [@championship.full_name, championship_predictions_path(championship_id: @championship.id)], "Rodada #{@round.number}" %>

<div style="text-align: center; margin-bottom: 30px;">
  <h1 style="color: #000080;">Rodada <%= @round.number %></h1>
  <p style="font-size: 18px; color: #666; margin-top: 10px;">
    <strong><%= @championship.full_name %></strong>
  </p>
  <div style="margin-top: 15px;">
    <%= link_to "Voltar", championship_predictions_path(championship_id: @championship.id), class: "btn" %>
  </div>
</div>

<div class="card">
  <%= form_with url: update_batch_predictions_path(championship_id: @championship.id, round_id: @round.id), method: :patch, local: true, id: "predictions-form" do %>
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Estadio</th>
          <th style="text-align: right;">Mandante</th>
          <th style="text-align: center;">Sua Previsao</th>
          <th>Visitante</th>
          <th style="text-align: center;">Status</th>
          <% if @round.all_matches_finished? %>
            <th style="text-align: center;">Placar Final</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @matches.each do |match| %>
          <% can_predict = match.can_predict? %>
          <% is_locked = match.locked? %>
          <% is_favorite_home = @championship.favorite_club_id.present? && match.home_club_id == @championship.favorite_club_id %>
          <% is_favorite_away = @championship.favorite_club_id.present? && match.away_club_id == @championship.favorite_club_id %>
          <tr style="<%= 'opacity: 0.6;' if is_locked %>">
            <td><%= match.scheduled_at&.strftime("%d/%m %H:%M") %></td>
            
            <td>
              <% if match.stadium %>
                <strong><%= match.stadium.name %></strong><br>
                <small style="color: #666;"><%= match.stadium.full_location %></small>
              <% else %>
                <span style="color: #999;">-</span>
              <% end %>
            </td>
            
            <td style="text-align: right;">
              <div style="display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                <strong><%= match.home_club.name %></strong>
                <% if is_favorite_home %>
                  <span style="color: #ffc107; font-size: 16px;">&#9733;</span>
                <% end %>
                <% if match.home_club.badge_url %>
                  <%= image_tag match.home_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.home_club.primary_color || '#ccc' %>; border-radius: 3px;"></div>
                <% end %>
              </div>
            </td>
            
            <td style="text-align: center;">
              <% prediction = @predictions[match.id] %>
              <% if can_predict %>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                  <%= number_field_tag "predictions[#{match.id}][home]", prediction&.home_score, 
                      min: 0, max: 20, 
                      class: "prediction-field",
                      data: { original: prediction&.home_score },
                      style: "width: 50px; text-align: center; padding: 5px;" %>
                  <strong>x</strong>
                  <%= number_field_tag "predictions[#{match.id}][away]", prediction&.away_score, 
                      min: 0, max: 20,
                      class: "prediction-field",
                      data: { original: prediction&.away_score },
                      style: "width: 50px; text-align: center; padding: 5px;" %>
                </div>
              <% else %>
                <% if prediction %>
                  <strong><%= prediction.home_score %> x <%= prediction.away_score %></strong>
                <% else %>
                  <span style="color: #999;">-</span>
                <% end %>
              <% end %>
            </td>
            
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <% if match.away_club.badge_url %>
                  <%= image_tag match.away_club.badge_url, style: "width: 30px; height: 30px; object-fit: contain;" %>
                <% else %>
                  <div style="width: 30px; height: 30px; background: <%= match.away_club.primary_color || '#ccc' %>; border-radius: 3px;"></div>
                <% end %>
                <% if is_favorite_away %>
                  <span style="color: #ffc107; font-size: 16px;">&#9733;</span>
                <% end %>
                <strong><%= match.away_club.name %></strong>
              </div>
            </td>
            
            <td style="text-align: center;">
              <% if match.finished? %>
                <span style="color: #28a745; font-weight: bold;">Finalizado</span>
              <% elsif is_locked %>
                <span style="color: #dc3545; font-weight: bold;">Bloqueado</span>
              <% else %>
                <span style="color: #ffc107; font-weight: bold;">Aberto</span>
              <% end %>
            </td>
            
            <% if @round.all_matches_finished? %>
              <td style="text-align: center;">
                <% if match.finished? %>
                  <strong style="color: #28a745;"><%= match.home_score %> x <%= match.away_score %></strong>
                <% else %>
                  <span style="color: #999;">-</span>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% if @matches.any? { |m| m.can_predict? } %>
      <%= submit_tag "Salvar Previsoes", id: "save-button", class: "btn", style: "margin-top: 20px;", disabled: true %>
    <% else %>
      <p style="text-align: center; color: #999; margin-top: 20px;">Todos os jogos estao bloqueados ou finalizados.</p>
    <% end %>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const saveButton = document.getElementById('save-button');
    const predictionFields = document.querySelectorAll('.prediction-field');
    
    if (!saveButton || predictionFields.length === 0) return;
    
    function checkForChanges() {
      let hasChanges = false;
      
      predictionFields.forEach(field => {
        const originalValue = field.dataset.original || '';
        const currentValue = field.value || '';
        
        if (originalValue !== currentValue) {
          hasChanges = true;
        }
      });
      
      saveButton.disabled = !hasChanges;
      saveButton.style.opacity = hasChanges ? '1' : '0.5';
      saveButton.style.cursor = hasChanges ? 'pointer' : 'not-allowed';
    }
    
    predictionFields.forEach(field => {
      field.addEventListener('input', checkForChanges);
      field.addEventListener('change', checkForChanges);
    });
    
    // Verificar no carregamento
    checkForChanges();
  });
  
  document.addEventListener('turbo:load', function() {
    const saveButton = document.getElementById('save-button');
    const predictionFields = document.querySelectorAll('.prediction-field');
    
    if (!saveButton || predictionFields.length === 0) return;
    
    function checkForChanges() {
      let hasChanges = false;
      
      predictionFields.forEach(field => {
        const originalValue = field.dataset.original || '';
        const currentValue = field.value || '';
        
        if (originalValue !== currentValue) {
          hasChanges = true;
        }
      });
      
      saveButton.disabled = !hasChanges;
      saveButton.style.opacity = hasChanges ? '1' : '0.5';
      saveButton.style.cursor = hasChanges ? 'pointer' : 'not-allowed';
    }
    
    predictionFields.forEach(field => {
      field.addEventListener('input', checkForChanges);
      field.addEventListener('change', checkForChanges);
    });
    
    checkForChanges();
  });
</script>
